<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../polymer/lib/elements/dom-if.html">
<link rel="import" href="../vaadin-combo-box/vaadin-combo-box.html">

<dom-module id="fs-fact-type">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>
    <div hidden$="[[edit]]">{{_factTypeDisplay(entityType, type)}}</div>
    <template is="dom-if" if="[[edit]]">
      <vaadin-combo-box id="select" 
        label="Type" 
        allow-custom-value
        no-label-float></vaadin-combo-box>
    </template>
  </template>

  <script>
    const FsFactTypes = [
      {
        type: 'http://gedcomx.org/BarMitzvah',
        name: 'Bar Mitzvah',
        entity: 'person',
        date: true,
        place: true,
        value: true
      },
      {
        type: 'http://gedcomx.org/BatMitzvah',
        name: 'Bat Mitzvah',
        entity: 'person',
        date: true,
        place: true,
        value: true
      },
      {
        type: 'http://gedcomx.org/Birth',
        name: 'Birth',
        entity: 'person',
        date: true,
        place: true,
        value: true
      },
      {
        type: 'http://gedcomx.org/Burial',
        name: 'Burial',
        entity: 'person',
        date: true,
        place: true,
        value: true
      },
      {
        type: 'http://gedcomx.org/Caste',
        name: 'Caste',
        entity: 'person',
        date: true,
        place: true,
        value: true
      },
      {
        type: 'http://gedcomx.org/Christening',
        name: 'Christening',
        entity: 'person',
        date: true,
        place: true,
        value: true
      },
      {
        type: 'http://gedcomx.org/Clan',
        name: 'Clan',
        entity: 'person',
        date: true,
        place: true,
        value: true
      },
      {
        type: 'http://gedcomx.org/Cremation',
        name: 'Cremation',
        entity: 'person',
        date: true,
        place: true,
        value: true
      },
      {
        type: 'http://gedcomx.org/Death',
        name: 'Death',
        entity: 'person',
        date: true,
        place: true,
        value: true
      },
      {
        type: 'http://gedcomx.org/Ethnicity',
        name: 'Ethnicity',
        entity: 'person',
        date: true,
        place: true,
        value: true
      },
      {
        type: 'http://gedcomx.org/MilitaryService',
        name: 'Military Service',
        entity: 'person',
        date: true,
        place: true,
        value: true
      },
      {
        type: 'http://gedcomx.org/NationalId',
        name: 'National Id',
        entity: 'person',
        date: true,
        place: true,
        value: true
      },
      {
        type: 'http://gedcomx.org/Nationality',
        name: 'Nationality',
        entity: 'person',
        date: true,
        place: true,
        value: true
      },
      {
        type: 'http://gedcomx.org/Naturalization',
        name: 'Naturalization',
        entity: 'person',
        date: true,
        place: true,
        value: true
      },
      {
        type: 'http://gedcomx.org/Occupation',
        name: 'Occupation',
        entity: 'person',
        date: true,
        place: true,
        value: true
      },
      {
        type: 'http://gedcomx.org/PhysicalDescription',
        name: 'Physical Description',
        entity: 'person',
        date: true,
        place: true,
        value: true
      },
      {
        type: 'http://gedcomx.org/Religion',
        name: 'Religion',
        entity: 'person',
        date: true,
        place: true,
        value: true
      },
      {
        type: 'http://gedcomx.org/Residence',
        name: 'Residence',
        entity: 'person',
        date: true,
        place: true,
        value: true
      },
      {
        type: 'http://gedcomx.org/Stillbirth',
        name: 'Stillbirth',
        entity: 'person',
        date: true,
        place: true,
        value: true
      },
      {
        type: 'http://familysearch.org/v1/Affiliation',
        name: 'Affiliation',
        entity: 'person',
        date: true,
        place: true,
        value: true
      },
      {
        type: 'http://familysearch.org/v1/DiedBeforeEight',
        name: 'Died Before Eight',
        entity: 'person',
        date: true,
        place: true,
        value: true
      },
      {
        type: 'http://familysearch.org/v1/TitleOfNobility',
        name: 'Title Of Nobility',
        entity: 'person',
        date: true,
        place: true,
        value: true
      },
      {
        type: 'http://familysearch.org/v1/TribeName',
        name: 'Tribe Name',
        entity: 'person',
        date: true,
        place: true,
        value: true
      },
      {
        type: 'http://gedcomx.org/Annulment',
        name: 'Annulment',
        entity: 'couple',
        date: true,
        place: true,
        value: true
      },
      {
        type: 'http://gedcomx.org/CommonLawMarriage',
        name: 'Common Law Marriage',
        entity: 'couple',
        date: true,
        place: true,
        value: true
      },
      {
        type: 'http://gedcomx.org/Divorce',
        name: 'Divorce',
        entity: 'couple',
        date: true,
        place: true,
        value: true
      },
      {
        type: 'http://gedcomx.org/Marriage',
        name: 'Marriage',
        entity: 'couple',
        date: true,
        place: true,
        value: true
      },
      {
        type: 'http://gedcomx.org/AdoptiveParent',
        name: 'Adoptive Parent',
        entity: 'capr',
        date: true,
        place: true,
        value: true
      },
      {
        type: 'http://gedcomx.org/BiologicalParent',
        name: 'Biological Parent',
        entity: 'capr',
        date: true,
        place: true,
        value: true
      },
      {
        type: 'http://gedcomx.org/FosterParent',
        name: 'Foster Parent',
        entity: 'capr',
        date: true,
        place: true,
        value: true
      },
      {
        type: 'http://gedcomx.org/GuardianParent',
        name: 'Guardian Parent',
        entity: 'capr',
        date: true,
        place: true,
        value: true
      },
      {
        type: 'http://gedcomx.org/StepParent',
        name: 'Step Parent',
        entity: 'capr',
        date: true,
        place: true,
        value: true
      }
    ];
    
    (function(){
      
      const typesIndex = FsFactTypes.reduce((index, type) => {
        index[type.type] = type;
        return index;
      }, {});
      
      /**
       * `fs-fact-type`
       * 
       *
       * @customElement
       * @polymer
       * @demo demo/index.html
       */
      class FsFactType extends Polymer.Element {
        static get is() { return 'fs-fact-type'; }
        static get properties() {
          return {
            type: {
              type: String,
              notify: true
            },
            
            /**
             * The entity type that the fact types should be limited to.
             * Valid values are: `person`, `couple`, `capr` (child-and-parents relationship).
             */
            entityType: {
              type: String,
              value: 'person'
            },
            
            /** Whether in edit mode */
            edit: {
              type: Boolean,
              value: false,
              observer: '_setupEdit'
            },
            
            /** Whether the fact type is a custom value */
            custom: {
              type: Boolean,
              value: false,
              readOnly: true,
              reflectToAttribute: true
            }
          };
        }
        static get observers() {
          return [
            '_customObserver(entityType, type)'
          ];
        }
        
        _factTypeDisplay(entityType, factType) {
          if(this._isCustom(entityType, factType)) {
            return factType;
          } else {
            return typesIndex[factType].name;
          }
        }
        
        _customObserver(entityType, type) {
          this._setCustom(this._isCustom(entityType, type));
        }
        
        /** Whether a type is custom */
        _isCustom(entityType, factType) {
          return !(typesIndex[factType] && typesIndex[factType].entity === entityType);
        }
        
        _setupEdit(edit) {
          if(edit) {
            Polymer.Async.microTask.run(() => {
              const select = this.shadowRoot.querySelector('#select');
              let selected;
              let item;
              
              // Populate the select box with types and watch for the selected value
              select.items = FsFactTypes.reduce((accumulator, type) => {
                if(type.entity === this.entityType) {
                  item = {
                    value: type.type,
                    label: type.name
                  };
                  accumulator.push(item);
                  if(item.value === this.type) {
                    selected = item;
                  }
                }
                return accumulator;
              }, []);
              
              // Set the selected value
              if(selected) {
                select.selectedItem = selected;
              } else {
                select.value = this.type;
              }
              
              // Listen for change events
              select.addEventListener('selected-item-changed', (e) => {
                if(e.detail.value) {
                  this.type = e.detail.value.value;
                }
              });
              select.addEventListener('custom-value-set', (e) => {
                if(e.detail) {
                  this.type = e.detail;
                }
              });
            });
          }
        }
      }

      window.customElements.define(FsFactType.is, FsFactType);
    })();
  </script>
</dom-module>
