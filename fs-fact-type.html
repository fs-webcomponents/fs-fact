<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../polymer/lib/elements/dom-if.html">
<link rel="import" href="../vaadin-combo-box/vaadin-combo-box.html">
<link rel="import" href="fs-fact-types.html">

<dom-module id="fs-fact-type">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>
    <div hidden$="[[edit]]">{{_factTypeDisplay(type)}}</div>
    <template is="dom-if" if="[[edit]]">
      <vaadin-combo-box id="select" 
        label="Type" 
        allow-custom-value
        no-label-float></vaadin-combo-box>
    </template>
  </template>
  <script>
    /**
     * `fs-fact-type`
     * 
     *
     * @customElement
     * @polymer
     * @demo demo/index.html
     */
    class FsFactType extends Polymer.Element {
      static get is() { return 'fs-fact-type'; }
      static get properties() {
        return {
          type: {
            type: String,
            notify: true
          },
          
          /**
           * The entity type that the fact types should be limited to.
           * Valid values are: `person`, `couple`, `capr` (child-and-parents relationship).
           */
          entityType: {
            type: String,
            value: 'person'
          },
          
          /** Whether in edit mode */
          edit: {
            type: Boolean,
            value: false,
            observer: '_setupEdit'
          },
          
          /** Whether the fact type is a custom value */
          custom: {
            type: Boolean,
            value: false,
            readOnly: true,
            reflectToAttribute: true
          }
        };
      }
      static get observers() {
        return [
          '_customObserver(type)'
        ];
      }
      
      _factTypeDisplay(type) {
        return FsFactTypes.displayName(type);
      }
      
      _customObserver(type) {
        this._setCustom(FsFactTypes.isCustom(type));
      }
      
      _setupEdit(edit) {
        if(edit) {
          Polymer.Async.microTask.run(() => {
            const select = this.shadowRoot.querySelector('#select');
            let selected;
            
            // Populate the select box with types and watch for the selected value
            select.items = FsFactTypes.typesByEntity(this.entityType).map((type) => {
              const item = {
                value: type.type,
                label: type.name
              };
              if(item.value === this.type) {
                selected = item;
              }
              return item;
            });
            
            // Set the selected value
            if(selected) {
              select.selectedItem = selected;
            } else {
              select.value = this.type;
            }
            
            // Listen for change events
            select.addEventListener('selected-item-changed', (e) => {
              if(e.detail.value) {
                this.type = e.detail.value.value;
              }
            });
            select.addEventListener('custom-value-set', (e) => {
              if(e.detail) {
                this.type = e.detail;
              }
            });
          });
        }
      }
    }

    window.customElements.define(FsFactType.is, FsFactType);
  </script>
</dom-module>
