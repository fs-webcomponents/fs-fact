<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../polymer/lib/elements/dom-if.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="fs-fact-types.html">
<link rel="import" href="fs-fact-value.html">
<link rel="import" href="../fs-date/fs-date.html">
<link rel="import" href="../fs-place/fs-place.html">
<link rel="import" href="../fs-request/fs-request.html">
<link rel="import" href="../fs-attribution/fs-attribution.html">

<dom-module id="fs-fact">
  <template>
    <style>
      :host {
        display: block;
      }
      
      .toolbar {
        visibility: hidden;
        text-align: right;
      }
      
      :host(:hover) .toolbar {
        visibility: visible;
      }
    </style>
    <template is="dom-if" if="[[editable]]">
      <div class="toolbar">
        <a id="edit" href hidden$="[[edit]]">Edit</a>
        <a id="close" href hidden$="[[!edit]]">Close</a>
        <a id="save" href hidden$="[[!_showSaveButton(edit, saveUrl)]]">Save</a>
      </div>
    </template>
    <div>{{_factTypeDisplay(fact.type)}}</div>
    <template is="dom-if" if="{{_supportsValue(fact.type)}}">
      <fs-fact-value value="{{fact.value}}" edit="[[edit]]"></fs-fact-value>
    </template>
    <template is="dom-if" if="{{_supportsDate(fact.type)}}">
      <fs-date date="{{fact.date}}" edit="[[edit]]"></fs-date>
    </template>
    <template is="dom-if" if="{{_supportsPlace(fact.type)}}">
      <fs-place place="{{fact.place}}" edit="[[edit]]"></fs-place>
    </template>
    <template is="dom-if" if="[[editable]]">
      <fs-attribution 
        hidden$="[[!edit]]" 
        attribution="{{fact.attribution}}"
        edit="[[edit]]"></fs-attribution>
    </template>
  </template>

  <script>
    /**
     * `fs-fact`
     * 
     *
     * @customElement
     * @polymer
     * @demo demo/index.html
     */
    class FsFact extends Polymer.Element {
      static get is() { return 'fs-fact'; }
      static get properties() {
        return {
          
          /** Fact data */
          fact: {
            type: Object,
            notify: true
          },
          
          /**
           * Whether the fact can be edited. This will show a toolbar when the
           * user hovers over the fact.
           */
          editable: {
            type: Boolean,
            value: false,
            observer: '_setupEditable'
          },
          
          /**
           * Whether the fact is currently in edit mode
           */
          edit: {
            type: Boolean,
            value: false
          },
          
          /**
           * The URL that the fact data will be saved to.
           */
          saveUrl: String,
          
          /**
           * Whether the fact is being saved
           */
          saving: {
            type: Boolean,
            value: false,
            readOnly: true,
            notify: true
          }
        };
      }
      
      _setupEditable(editable) {
        if(editable) {
          setTimeout(() => {
            this.shadowRoot.querySelector('#edit').addEventListener('click', (e) => {
              this.edit = true;
              e.preventDefault();
            });
            this.shadowRoot.querySelector('#close').addEventListener('click', (e) => {
              this.edit = false;
              e.preventDefault();
            });
            this.shadowRoot.querySelector('#save').addEventListener('click', (e) => {
              this.edit = false;
              e.preventDefault();
              if(this.saveUrl) {
                const request = document.createElement('fs-request');
                request.url = this.saveUrl;
                request.method = 'POST';
                request.body = {
                  persons: [{
                    facts: [this.fact]
                  }]
                };
                request.delegateEvents(this);
                request.addEventListener('loading-changed', (e) => {
                  this._setSaving(e.detail.value);
                });
                request.generateRequest();
              }
            });
          });
        }
      }
      
      _showSaveButton(edit, saveUrl) {
        return edit && saveUrl;
      }
      
      _factTypeDisplay(type) {
        return FsFactTypes.displayName(type);
      }
      
      _supportsPlace(type) {
        return FsFactTypes.supportsPlace(type);
      }
      
      _supportsDate(type) {
        return FsFactTypes.supportsDate(type);
      }
      
      _supportsValue(type) {
        return FsFactTypes.supportsValue(type);
      }
    }

    window.customElements.define(FsFact.is, FsFact);
  </script>
</dom-module>
